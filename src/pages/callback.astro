<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>Astro</title>
  </head>
  <body>
    <h1>Callback!</h1>
  </body>
</html>

<script>
  import { Buffer } from "buffer";
  import Cookies from "js-cookie";

  const url_params = new URLSearchParams(window.location.search);
  const code = url_params.get("code");

  const client_id = import.meta.env.PUBLIC_CLIENT_ID;
  const client_secret = import.meta.env.PUBLIC_CLIENT_SECRET;
  const redirect_uri = import.meta.env.PUBLIC_REDIRECT_URI;

  let body = new URLSearchParams({
    code,
    redirect_uri,
    grant_type: "authorization_code",
  });

  let response = await fetch("https://accounts.spotify.com/api/token", {
    method: "post",
    body,
    headers: {
      "Content-type": "application/x-www-form-urlencoded",
      Authorization:
        "Basic " +
        Buffer.from(client_id + ":" + client_secret).toString("base64"),
    },
  });

  let data = await response.json();

  Cookies.set("access_token", data.access_token);

  window.location.replace("/dashboard");
</script>
